---
import Code from './Code.astro';
import prettier from 'prettier';

/**
 * Example component that displays a preview and auto-extracts the code
 *
 * @param {string} language - Programming language for syntax highlighting (default: 'html')
 */
interface Props {
  language?: string;
}

const { language = 'html' } = Astro.props;

// Get the raw HTML from the slot
const slotHtml = await Astro.slots.render('default');

// Extract and format code using prettier
async function extractCode(html: string): Promise<string> {
  if (!html || typeof html !== 'string') return '';

  // Remove Astro dev tool attributes
  let cleaned = html.replace(/\s+data-astro-source-file="[^"]*"/g, '');
  cleaned = cleaned.replace(/\s+data-astro-source-loc="[^"]*"/g, '');

  // Format with prettier
  try {
    const result = await prettier.format(cleaned, {
      parser: 'html',
      htmlWhitespaceSensitivity: 'ignore',
      printWidth: 80,
      tabWidth: 2,
    });

    // Ensure we return a string
    if (typeof result === 'string') {
      return result;
    }

    return String(result);
  } catch (error) {
    console.error('Prettier formatting error:', error);
    // Fallback to original if formatting fails
    return cleaned;
  }
}

// Extract code from slot
const code = await extractCode(slotHtml || '');
---

<section class="example">
  <slot />
</section>
<Code language={language} code={code} />
