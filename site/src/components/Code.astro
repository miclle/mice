---
/**
 * Code component for displaying syntax-highlighted code examples
 *
 * @param {string} code - The raw code content (no need to escape HTML)
 * @param {string} language - Programming language for syntax highlighting (e.g., 'html', 'css', 'javascript')
 * @param {boolean} [showLineNumbers=false] - Whether to show line numbers
 */
interface Props {
  code: string;
  language: string;
  showLineNumbers?: boolean;
}

const { code, language, showLineNumbers = false } = Astro.props;

// Escape HTML special characters
function escapeHtml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// Trim leading empty lines and common indentation
function normalizeCode(text: string): string {
  const lines = text.split('\n');

  // Remove leading empty lines
  let startIndex = 0;
  while (startIndex < lines.length && lines[startIndex].trim() === '') {
    startIndex++;
  }

  // Remove trailing empty lines
  let endIndex = lines.length - 1;
  while (endIndex >= startIndex && lines[endIndex].trim() === '') {
    endIndex--;
  }

  const trimmedLines = lines.slice(startIndex, endIndex + 1);

  // Find common indentation (minimum non-zero indentation)
  const indentPattern = /^\s*/;
  const commonIndent = trimmedLines
    .filter((line) => line.trim() !== '')
    .map((line) => line.match(indentPattern)?.[0]?.length || 0)
    .reduce((min, indent) => Math.min(min, indent), Infinity);

  // Remove common indentation
  const dedentedLines = trimmedLines.map((line) => line.slice(commonIndent));

  return dedentedLines.join('\n');
}

const normalizedCode = normalizeCode(code);
const escapedCode = escapeHtml(normalizedCode);
const classes = showLineNumbers ? `language-${language} line-numbers` : `language-${language}`;

// Generate unique ID for copy button
const uniqueId = 'code-' + Math.random().toString(36).substring(2, 9);
---

<div class="code-block" style="position: relative;">
  <button
    class="btn-copy"
    data-code-id={uniqueId}
    title="Copy to clipboard"
    onclick="copyCode(this)"
  >
    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
      <path
        d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"
      ></path>
      <path
        d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"
      ></path>
    </svg>
  </button>
  <pre id={uniqueId}><code class={classes} set:html={escapedCode} /></pre>
</div>

<script is:inline>
  function copyCode(button) {
    const codeId = button.dataset.codeId;
    const pre = document.getElementById(codeId);
    const code = pre.querySelector('code');
    const text = code.textContent;

    navigator.clipboard.writeText(text).then(() => {
      const originalHTML = button.innerHTML;
      button.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
      </svg>`;
      setTimeout(() => {
        button.innerHTML = originalHTML;
      }, 2000);
    });
  }
</script>
