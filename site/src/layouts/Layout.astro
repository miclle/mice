---
import Navbar from '../components/Navbar.astro';
import Sidebar from '../components/Sidebar.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title: string;
  bodyClass?: string;
  activeSection?: 'docs';
  currentPage?: string;
  showSidebar?: boolean;
  showToc?: boolean;
  editPath?: string;
}

const {
  title,
  bodyClass = '',
  activeSection,
  currentPage = '',
  showSidebar = true,
  showToc = true,
  editPath,
} = Astro.props;

// Generate GitHub edit URL
const githubRepo = 'miclle/semantic-element';
const githubBranch = 'main';
const githubEditUrl = editPath
  ? `https://github.com/${githubRepo}/edit/${githubBranch}/${editPath}`
  : null;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <title>{title}</title>

    <link href="/stylesheets/semantic-element.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/doc.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/doc-style.css" rel="stylesheet" type="text/css" />

    <!-- highlight.js with dark theme support -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
      id="highlight-light"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
      id="highlight-dark"
      disabled
    />

    <script
      is:inline
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="/javascripts/highlight.js" type="text/javascript"></script>
    <script src="/javascripts/alert.js" type="text/javascript"></script>
    <script src="/javascripts/dialog.js" type="text/javascript"></script>
    <script src="/javascripts/tooltip.js" type="text/javascript"></script>
  </head>

  <body class={bodyClass}>
    <Navbar activeSection={activeSection} />

    {
      showSidebar ? (
        <div class="docs-wrapper">
          <aside class="bd-sidebar">
            <Sidebar currentPage={currentPage} />
          </aside>

          <main class="bd-main">
            <article>
              <slot />

              {githubEditUrl && (
                <div class="edit-on-github">
                  <hr />
                  <a href={githubEditUrl} target="_blank" rel="noopener noreferrer">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                      <path
                        d="M12.854 2.854a.5.5 0 0 0-.708-.708l-9 9a.5.5 0 0 0-.146.353v2a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .353-.146l9-9zM13 1.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z"
                      ></path>
                    </svg>
                    Edit this page on GitHub
                  </a>
                </div>
              )}
            </article>
          </main>

          {showToc && (
            <aside class="bd-toc">
              <strong>On this page</strong>
              <nav id="toc-nav">
                <ul id="toc-list"></ul>
              </nav>
            </aside>
          )}
        </div>
      ) : (
        <main>
          <slot />
        </main>
      )
    }

    <Footer />

    <!-- Theme Switcher Script -->
    <script is:inline>
      (function () {
        const getStoredTheme = () => localStorage.getItem('theme');
        const setStoredTheme = (theme) => localStorage.setItem('theme', theme);

        const getPreferredTheme = () => {
          const storedTheme = getStoredTheme();
          if (storedTheme) {
            return storedTheme;
          }
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        const setTheme = (theme) => {
          const actualTheme = theme === 'auto' ? getPreferredTheme() : theme;
          document.documentElement.setAttribute('data-bs-theme', actualTheme);

          // Update highlight.js theme
          const lightTheme = document.getElementById('highlight-light');
          const darkTheme = document.getElementById('highlight-dark');
          if (actualTheme === 'dark') {
            lightTheme.disabled = true;
            darkTheme.disabled = false;
          } else {
            lightTheme.disabled = false;
            darkTheme.disabled = true;
          }

          // Update active button
          document.querySelectorAll('.theme-switcher button').forEach((btn) => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
          });
        };

        // Initialize theme
        setTheme(getStoredTheme() || 'auto');

        // Listen for theme changes
        window.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.theme-switcher button').forEach((button) => {
            button.addEventListener('click', () => {
              const theme = button.dataset.theme;
              setStoredTheme(theme);
              setTheme(theme);
            });
          });
        });

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
          const storedTheme = getStoredTheme();
          if (storedTheme === 'auto' || !storedTheme) {
            setTheme('auto');
          }
        });
      })();
    </script>

    <!-- TOC Generator Script -->
    <script is:inline>
      window.addEventListener('DOMContentLoaded', () => {
        const tocList = document.getElementById('toc-list');
        if (!tocList) return;

        const article = document.querySelector('article');
        if (!article) return;

        const headings = article.querySelectorAll('h2, h3');
        if (headings.length === 0) return;

        const fragment = document.createDocumentFragment();

        headings.forEach((heading, index) => {
          // Add ID if not present
          if (!heading.id) {
            heading.id =
              heading.textContent.toLowerCase().replace(/[^\w]+/g, '-') + '-' + index;
          }

          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#' + heading.id;
          a.textContent = heading.textContent;

          // Handle nested headings
          if (heading.tagName === 'H3') {
            const lastLi = fragment.lastChild || tocList.lastChild;
            if (lastLi) {
              let nestedUl = lastLi.querySelector('ul');
              if (!nestedUl) {
                nestedUl = document.createElement('ul');
                lastLi.appendChild(nestedUl);
              }
              nestedUl.appendChild(li);
            } else {
              fragment.appendChild(li);
            }
          } else {
            fragment.appendChild(li);
          }

          li.appendChild(a);
        });

        tocList.appendChild(fragment);

        // Active link on scroll
        const links = tocList.querySelectorAll('a');
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const id = entry.target.getAttribute('id');
              const link = tocList.querySelector(`a[href="#${id}"]`);
              if (link) {
                if (entry.isIntersecting) {
                  links.forEach((l) => l.classList.remove('active'));
                  link.classList.add('active');
                }
              }
            });
          },
          { rootMargin: '-100px 0px -66%' }
        );

        headings.forEach((heading) => observer.observe(heading));
      });
    </script>
  </body>
</html>
